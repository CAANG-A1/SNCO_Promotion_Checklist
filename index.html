<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNCO Promotion Review Terminal</title>
    <!-- Core Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f1f5f9;
            position: relative;
        }

        /* --- ADVANCED PRINT ENGINE --- */
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; padding: 0 !important; margin: 0 !important; height: auto !important; width: 100% !important; color: black !important; }
            
            /* Unwrap the modal for the printer */
            #print-modal { 
                display: block !important; 
                position: relative !important; 
                background: white !important;
                visibility: visible !important;
                z-index: auto !important;
                inset: auto !important;
                padding: 0 !important;
                margin: 0 !important;
                width: 100% !important;
                height: auto !important;
                box-shadow: none !important;
                overflow: visible !important;
            }
            
            #print-modal > div {
                display: block !important;
                position: relative !important;
                width: 100% !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                overflow: visible !important;
            }
            
            .modal-overlay { background: transparent !important; backdrop-filter: none !important; }
            
            /* Paper Settings */
            #print-paper { 
                box-shadow: none !important; 
                margin: 0 auto !important; 
                width: 100% !important; 
                height: auto !important; 
                min-height: auto !important; 
                border: none !important;
                padding: 0.5in !important; /* Standard print margin */
            }
            
            /* Remove scroll containers during print */
            .flex-1.overflow-y-auto { overflow: visible !important; height: auto !important; }
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        #guidance-popup {
            pointer-events: none;
            transition: opacity 0.15s ease-in-out, transform 0.15s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 5000;
            transform: translateY(10px);
        }

        .modal-overlay {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(4px);
        }

        .audit-table th {
            text-align: left;
            font-size: 10px;
            font-weight: 800;
            color: #64748b;
            padding: 8px 16px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .audit-table td {
            padding: 8px 16px;
            font-size: 11px;
            border-top: 1px solid #f1f5f9;
        }
    </style>
</head>
<body class="text-slate-900 min-h-screen p-4 md:p-8">

    <!-- FLOATING GUIDANCE POPUP -->
    <div id="guidance-popup" class="hidden opacity-0 absolute bg-slate-900 text-white p-4 rounded-2xl shadow-2xl max-w-xs text-[11px] font-medium leading-relaxed border border-white/10 no-print">
        <div class="flex items-center gap-2 mb-2 border-b border-white/10 pb-2">
            <i data-lucide="info" class="w-4 h-4 text-blue-400"></i>
            <span class="font-black uppercase tracking-widest text-blue-400">Policy Guidance</span>
        </div>
        <p id="guidance-text" class="text-slate-300"></p>
        <div class="absolute left-6 -bottom-2 w-4 h-4 bg-slate-900 rotate-45 border-r border-b border-white/10"></div>
    </div>

    <!-- PRINT PREVIEW MODAL -->
    <div id="print-modal" class="hidden fixed inset-0 z-[2000] flex items-center justify-center p-4 md:p-12 modal-overlay">
        <div class="bg-white w-full max-w-5xl h-full rounded-[40px] shadow-2xl overflow-hidden flex flex-col animate-in zoom-in-95 duration-300">
            <div class="p-6 border-b border-slate-200 flex justify-between items-center bg-white no-print">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-blue-600 rounded-lg text-white"><i data-lucide="file-text" class="w-5 h-5"></i></div>
                    <h2 class="font-black uppercase italic tracking-tighter">Document Preview</h2>
                </div>
                <div class="flex gap-3">
                    <button onclick="closePrintPreview()" class="px-6 py-2 rounded-xl text-xs font-bold text-slate-500 hover:bg-slate-100 transition-all uppercase tracking-widest">Close</button>
                    <button onclick="window.print()" class="px-8 py-2 bg-blue-600 text-white rounded-xl text-xs font-black shadow-lg hover:bg-blue-700 transition-all uppercase tracking-widest flex items-center gap-2">
                        <i data-lucide="printer" class="w-4 h-4"></i> Finalize & Print
                    </button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 md:p-12 bg-slate-200/50 flex justify-center custom-scrollbar">
                <!-- PREVIEW PAPER -->
                <div id="print-paper" class="bg-white w-[8.5in] min-h-[11in] h-fit shadow-2xl p-16 space-y-8 uppercase text-slate-900 font-medium">
                    <div class="text-center border-b-4 border-slate-900 pb-6">
                        <h2 class="text-3xl font-black italic tracking-tighter underline decoration-blue-600 underline-offset-8 uppercase leading-tight">Promotion Certification</h2>
                        <p class="text-[10px] font-bold tracking-[0.2em] mt-4 opacity-50">California Air National Guard | Official Review Record</p>
                    </div>

                    <div class="grid grid-cols-2 gap-8 font-black border-b border-slate-100 pb-6">
                        <div class="space-y-4">
                            <div><p class="text-[9px] text-slate-400 mb-0.5 uppercase">Candidate</p><p id="prev-name" class="text-xs font-black h-4"></p></div>
                            <div><p class="text-[9px] text-slate-400 mb-0.5 uppercase">Target Rank</p><p id="prev-rank" class="text-xs font-black h-4"></p></div>
                        </div>
                        <div class="space-y-4">
                            <div><p class="text-[9px] text-slate-400 mb-0.5 uppercase">Assigned Unit</p><p id="prev-unit" class="text-xs font-black h-4"></p></div>
                            <div><p class="text-[9px] text-slate-400 mb-0.5 uppercase">Review Status</p><p id="prev-status" class="text-xs font-black h-4"></p></div>
                        </div>
                    </div>

                    <!-- COMPLIANCE AUDIT TABLE -->
                    <div class="space-y-4">
                        <div class="flex items-center gap-3">
                            <div class="w-1.5 h-6 bg-blue-600"></div>
                            <h3 class="text-sm font-black italic uppercase tracking-tighter">Compliance Audit & Evidence</h3>
                        </div>
                        <div class="border border-slate-200 rounded-3xl overflow-hidden">
                            <table class="w-full audit-table">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="w-1/3">Qualification Category</th>
                                        <th class="w-1/2">Evidence / Policy Requirement</th>
                                        <th class="text-center">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="prev-audit-table-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- REVIEWER REMARKS -->
                    <div class="space-y-4">
                        <div class="flex items-center gap-3">
                            <div class="w-1.5 h-6 bg-blue-600"></div>
                            <h3 class="text-sm font-black italic uppercase tracking-tighter">Reviewer Remarks</h3>
                        </div>
                        <div class="min-h-[80px] p-6 bg-slate-50 border border-slate-200 rounded-3xl">
                            <p id="prev-comments" class="text-[11px] normal-case leading-relaxed italic text-slate-700 font-medium"></p>
                        </div>
                    </div>

                    <!-- SIGNATURE BLOCK - GRID LAYOUT (ONE LINE) -->
                    <div class="pt-8 grid grid-cols-2 gap-12 border-t border-slate-100">
                        <div class="border-b-2 border-slate-900 pb-2">
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Reviewer Name/Rank</p>
                            <p id="prev-reviewer-info" class="text-[11px] font-black mt-2 h-5"></p>
                        </div>
                        <div class="border-b-2 border-slate-900 pb-2">
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Digital Signature / Date</p>
                            <div class="h-8"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div class="max-w-6xl mx-auto space-y-6 no-print">
        <header class="bg-white rounded-[32px] shadow-sm border border-slate-200 p-6 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-slate-900 rounded-2xl flex items-center justify-center text-white">
                    <i data-lucide="shield-check" class="w-8 h-8"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-black tracking-tight uppercase italic tracking-tighter leading-none">SNCO Promotion Terminal</h1>
                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">California Air National Guard | Compliance Engine</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="openPrintPreview()" class="px-6 py-2.5 bg-blue-600 text-white hover:bg-blue-700 rounded-xl text-xs font-black flex items-center gap-2 uppercase tracking-widest transition-all shadow-lg shadow-blue-900/10">
                    <i data-lucide="printer" class="w-4 h-4"></i> Print Review
                </button>
                <button onclick="location.reload()" class="p-3 text-slate-400 hover:text-red-500 transition-colors">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <div class="bg-white rounded-[32px] shadow-sm border border-slate-200 p-8">
            <div id="stepper-container" class="flex justify-between items-start max-w-3xl mx-auto"></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-stretch">
            
            <!-- FORM -->
            <div class="lg:col-span-8 bg-white rounded-[40px] shadow-sm border border-slate-200 flex flex-col max-h-[850px] overflow-hidden relative">
                <div class="flex-1 p-6 md:p-10 overflow-y-auto custom-scrollbar">
                    
                    <!-- STEP 1 -->
                    <div id="step-1" class="snco-step space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                        <div class="border-b border-slate-100 pb-4">
                            <h2 class="text-2xl font-black tracking-tight uppercase italic tracking-tighter">1. Member Identification</h2>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Candidate Name</label>
                                <input type="text" id="prof-name" oninput="sncoUpdateField('profile', 'name', this.value)" class="guidance-trigger w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 font-bold uppercase outline-none focus:ring-2 focus:ring-blue-500" placeholder="DOE, JANE A">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Assigned Unit</label>
                                <input type="text" id="prof-unit" oninput="sncoUpdateField('profile', 'unit', this.value)" class="guidance-trigger w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 font-bold uppercase outline-none focus:ring-2 focus:ring-blue-500" placeholder="144 FW / FSS">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Target Rank</label>
                                <select id="prof-rank" onchange="sncoUpdateField('profile', 'targetRank', this.value)" class="guidance-trigger w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 font-bold outline-none">
                                    <option value="TSgt">TSgt (E-6)</option>
                                    <option value="MSgt" selected>MSgt (E-7)</option>
                                    <option value="SMSgt">SMSgt (E-8)</option>
                                    <option value="CMSgt">CMSgt (E-9)</option>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-blue-600 uppercase tracking-widest">Authorized Position Grade (UMD)</label>
                                <select id="prof-positionGrade" onchange="sncoUpdateField('profile', 'positionGrade', this.value)" class="guidance-trigger w-full border-2 bg-slate-50 border-blue-200 rounded-2xl p-4 font-bold outline-none">
                                    <option value="TSgt">TSgt (E-6)</option>
                                    <option value="MSgt" selected>MSgt (E-7)</option>
                                    <option value="SMSgt">SMSgt (E-8)</option>
                                    <option value="CMSgt">CMSgt (E-9)</option>
                                </select>
                            </div>
                            <div class="space-y-2 md:col-span-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Program Logic</label>
                                <select id="prof-package" onchange="sncoUpdateField('profile', 'packageType', this.value)" class="guidance-trigger w-full border-2 bg-slate-50 border-slate-200 rounded-2xl p-4 font-bold outline-none text-blue-600">
                                    <option value="Standard">Standard Vacancy</option>
                                    <option value="STEP_I">STEP I (E6/E7)</option>
                                    <option value="STEP_II">STEP II (E8/E9)</option>
                                    <option value="Retraining">Retraining Promotion</option>
                                </select>
                            </div>
                            <div class="space-y-2 md:col-span-2 p-6 bg-blue-50 rounded-[32px] border border-blue-100 flex flex-col md:flex-row gap-6 items-center">
                                <div class="flex-1 space-y-1">
                                    <label class="text-[10px] font-black text-blue-600 uppercase tracking-widest block">HQ Submission Date</label>
                                    <p class="text-[10px] text-slate-400 font-medium italic leading-tight">Fitness must remain current through the end of the month following this date.</p>
                                </div>
                                <input type="date" id="readiness-submissionDate" oninput="sncoUpdateField('readiness', 'submissionDate', this.value)" class="guidance-trigger w-full md:w-auto bg-white border border-blue-200 rounded-2xl p-4 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="space-y-2 md:col-span-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Component Status</label>
                                <div id="component-toggle" class="flex bg-slate-100 rounded-xl p-1 gap-1"></div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 2 -->
                    <div id="step-2" class="snco-step hidden space-y-6 animate-in fade-in slide-in-from-right-4 duration-500">
                        <div class="border-b border-slate-100 pb-4">
                            <h2 class="text-2xl font-black tracking-tight uppercase tracking-tighter italic leading-none">2. Service & Prof. Development</h2>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="space-y-4">
                                <div class="space-y-1">
                                    <label id="tis-label" class="text-[10px] font-black text-slate-400 uppercase tracking-widest"></label>
                                    <input type="date" id="service-payDate" oninput="sncoUpdateField('service', 'payDate', this.value)" class="guidance-trigger w-full bg-slate-50 border border-slate-200 rounded-2xl p-3 text-sm font-bold outline-none">
                                </div>
                                <div class="space-y-1">
                                    <label id="tig-label" class="text-[10px] font-black text-slate-400 uppercase tracking-widest"></label>
                                    <input type="date" id="service-dor" oninput="sncoUpdateField('service', 'dor', this.value)" class="guidance-trigger w-full bg-slate-50 border border-slate-200 rounded-2xl p-3 text-sm font-bold outline-none">
                                </div>
                                <div class="space-y-1">
                                    <label id="epb-label" class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Latest EPB Closeout Date</label>
                                    <input type="date" id="service-epbDate" oninput="sncoUpdateField('service', 'epbDate', this.value)" class="guidance-trigger w-full bg-blue-50 border border-blue-100 rounded-2xl p-3 text-sm font-bold outline-none transition-all">
                                </div>
                                <div class="bg-slate-900 rounded-[32px] p-6 space-y-4 shadow-xl">
                                    <h3 class="text-[10px] font-black text-blue-400 uppercase tracking-widest flex items-center gap-2"><i data-lucide="graduation-cap" class="w-4 h-4"></i> Professional Development</h3>
                                    <div class="space-y-3">
                                        <div id="row-ncoa" class="flex items-center justify-between p-3 bg-slate-800 rounded-xl border border-slate-700 cursor-pointer" onclick="sncoTogglePME('NCOA')">
                                            <span class="text-[10px] font-bold text-slate-300">NCOA Complete?</span>
                                            <input type="checkbox" id="flag-ncoa" class="w-4 h-4 rounded text-blue-500 pointer-events-none">
                                        </div>
                                        <div id="row-sncoa" class="flex items-center justify-between p-3 bg-slate-800 rounded-xl border border-slate-700 cursor-pointer" onclick="sncoTogglePME('SNCOA')">
                                            <span class="text-[10px] font-bold text-slate-300">SNCOA Complete?</span>
                                            <input type="checkbox" id="flag-sncoa" class="w-4 h-4 rounded text-blue-500 pointer-events-none">
                                        </div>
                                        <div id="row-degree" class="flex items-center justify-between p-3 bg-slate-800 rounded-xl border border-slate-700 cursor-pointer" onclick="sncoToggleDegree()">
                                            <span class="text-[10px] font-bold text-slate-300">CCAF / Associate Degree?</span>
                                            <input type="checkbox" id="flag-degree" class="w-4 h-4 rounded text-blue-500 pointer-events-none">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div id="tafms-container" class="p-6 rounded-[32px] space-y-4 shadow-xl border-2 transition-all">
                                    <div class="flex justify-between items-center border-b border-white/10 pb-2">
                                        <span id="service-type-label" class="text-[9px] font-black uppercase"></span>
                                        <span id="service-summary-value" class="font-black text-xs"></span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label class="text-[9px] font-bold uppercase opacity-50 mb-1 block">Years</label><input type="number" id="service-yrs-input" oninput="sncoUpdateServiceValue('Years', this.value)" class="guidance-trigger w-full rounded-xl p-3 text-xl font-black outline-none border-2"></div>
                                        <div><label class="text-[9px] font-bold uppercase opacity-50 mb-1 block">Months</label><input type="number" id="service-mos-input" oninput="sncoUpdateServiceValue('Months', this.value)" class="guidance-trigger w-full rounded-xl p-3 text-xl font-black outline-none border-2" max="11"></div>
                                    </div>
                                </div>
                                <div class="p-6 bg-slate-50 rounded-[32px] border border-slate-200 space-y-4 shadow-inner">
                                    <div class="flex justify-between items-center border-b pb-2">
                                        <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Skill Level Audit</h3>
                                        <span id="slot-req-badge" class="bg-blue-600 text-white text-[8px] font-black px-2 py-0.5 rounded-full"></span>
                                    </div>
                                    <div class="space-y-4">
                                        <div class="space-y-1">
                                            <label class="text-[9px] font-bold text-slate-500 uppercase">Awarded PAFSC Level</label>
                                            <select id="service-pafsc" onchange="sncoUpdateField('service', 'pafscLevel', this.value)" class="w-full bg-white border border-slate-200 rounded-xl p-3 text-xs font-black"><option value="1">1</option><option value="3">3</option><option value="5">5</option><option value="7" selected>7</option><option value="9">9</option></select>
                                        </div>
                                        <div class="space-y-1">
                                            <label class="text-[9px] font-bold text-slate-500 uppercase">Member Skill Level in Duty</label>
                                            <select id="service-dafsc" onchange="sncoUpdateField('service', 'dafscLevel', this.value)" class="w-full bg-white border border-slate-200 rounded-xl p-3 text-xs font-black"><option value="1">1</option><option value="3">3</option><option value="5">5</option><option value="7" selected>7</option><option value="9">9</option></select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 3 -->
                    <div id="step-3" class="snco-step hidden space-y-6 animate-in fade-in slide-in-from-right-4 duration-500">
                        <div class="border-b border-slate-100 pb-4">
                            <h2 class="text-2xl font-black tracking-tight uppercase tracking-tighter italic leading-none">3. Readiness & Fitness Review</h2>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="space-y-1">
                                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Fitness Score</label>
                                        <input type="number" id="readiness-fitScore" oninput="sncoUpdateField('readiness', 'fitScore', this.value)" class="guidance-trigger w-full bg-slate-50 border border-slate-200 rounded-xl p-3 font-bold outline-none" placeholder="0-100">
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Status</label>
                                        <select id="readiness-fitStatus" onchange="sncoUpdateField('readiness', 'fitStatus', this.value)" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-xs font-bold outline-none">
                                            <option value="Passing">Passing</option><option value="Failing">Failing</option><option value="Exempt">Exempt</option><option value="Pregnancy">Pregnancy Exemption</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <label id="fit-exp-label" class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Fitness Expiration Date</label>
                                    <input type="date" id="readiness-fitExpirationDate" oninput="sncoUpdateField('readiness', 'fitExpirationDate', this.value)" class="guidance-trigger w-full border-2 rounded-xl p-3 font-bold outline-none bg-slate-50 border-slate-200 transition-all">
                                </div>
                                <div id="fit-currency-box" class="p-4 rounded-2xl border bg-slate-50 space-y-1">
                                    <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Mandatory Currency Target</p>
                                    <p id="fit-currency-target" class="text-[11px] font-bold text-slate-600">Enter Submission Date in Step 1...</p>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div class="space-y-1">
                                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Security Adjudication Date</label>
                                    <input type="date" id="clearance-input" oninput="sncoUpdateField('readiness', 'clearanceDate', this.value)" class="guidance-trigger w-full border-2 rounded-xl p-3 font-bold outline-none bg-slate-50 border-slate-200 transition-all">
                                </div>
                                <div class="bg-slate-50 p-6 rounded-[32px] border border-slate-200 space-y-4 shadow-inner">
                                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest border-b pb-2 leading-none">Admin Barriers</p>
                                    <div id="admin-flags" class="space-y-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 4 -->
                    <div id="step-4" class="snco-step hidden space-y-8 animate-in fade-in slide-in-from-right-4 duration-500">
                        <div class="border-b border-slate-100 pb-4">
                            <h2 class="text-2xl font-black tracking-tight uppercase tracking-tighter italic leading-none">4. Verification & Reviewer Profile</h2>
                        </div>
                        <div class="space-y-8">
                            <div class="bg-slate-50 p-8 rounded-[40px] border border-slate-200 shadow-inner space-y-6">
                                <h3 class="font-black text-xs uppercase text-blue-600 flex items-center gap-3"><i data-lucide="clipboard-list" class="w-5 h-5"></i> Verification Checklist</h3>
                                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                                    <div class="lg:col-span-5">
                                        <div id="board-comp-box" class="guidance-trigger p-4 bg-white rounded-3xl border border-slate-200 shadow-sm flex items-center justify-between cursor-pointer h-20 transition-all hover:border-blue-300" onclick="sncoToggleComposition()" tabindex="0">
                                            <div class="space-y-1">
                                                <p class="text-[10px] font-black uppercase text-slate-700 tracking-tighter">Board Composition OK?</p>
                                                <p id="board-req-text" class="text-[11px] font-black text-blue-600 leading-tight"></p>
                                            </div>
                                            <input type="checkbox" id="board-comp-checkbox" class="w-6 h-6 rounded text-blue-600 pointer-events-none">
                                        </div>
                                    </div>
                                    <div id="folder-checklist" class="lg:col-span-7 grid grid-cols-1 md:grid-cols-2 gap-2"></div>
                                </div>
                            </div>
                            <div class="bg-slate-50 p-8 rounded-[40px] border border-slate-200 shadow-inner space-y-6">
                                <h3 class="font-black text-xs uppercase text-blue-600 flex items-center gap-3"><i data-lucide="user-check" class="w-5 h-5"></i> Certifying Reviewer Details</h3>
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div class="md:col-span-3">
                                            <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest block mb-1">Full Name</label>
                                            <input type="text" id="rev-name" oninput="sncoUpdateField('reviewer', 'name', this.value)" class="guidance-trigger w-full bg-white border border-slate-200 rounded-xl p-3 text-xs font-bold outline-none" placeholder="DOE, JOHN B">
                                        </div>
                                        <div class="md:col-span-1">
                                            <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest block mb-1">Rank</label>
                                            <input type="text" id="rev-rank" oninput="sncoUpdateField('reviewer', 'rank', this.value)" class="guidance-trigger w-full bg-white border border-slate-200 rounded-xl p-3 text-xs font-bold outline-none" placeholder="SMSGT">
                                        </div>
                                        <div class="md:col-span-2">
                                            <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest block mb-1">Unit</label>
                                            <input type="text" id="rev-unit" oninput="sncoUpdateField('reviewer', 'unit', this.value)" class="guidance-trigger w-full bg-white border border-slate-200 rounded-xl p-3 text-xs font-bold outline-none" placeholder="144 FSS / MPF">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest block mb-1">Reviewer Remarks</label>
                                        <textarea id="rev-comments" oninput="sncoUpdateField('reviewer', 'comments', this.value)" class="guidance-trigger w-full bg-white border border-slate-200 rounded-xl p-3 text-[10px] font-medium min-h-[105px] outline-none" placeholder="Enter board findings or waiver notes..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NAVIGATION FOOTER -->
                <div class="bg-slate-50 p-6 border-t border-slate-100 flex justify-between items-center no-print">
                    <button id="prev-btn" onclick="sncoChangeStep(-1)" class="px-8 py-3 text-xs font-black text-slate-400 uppercase tracking-widest hover:text-slate-600 transition-colors">
                        <i data-lucide="chevron-left" class="inline-block w-4 h-4 mr-1"></i> Back
                    </button>
                    <div class="flex gap-4">
                        <button id="first-sgt-btn" onclick="sncoToggleFirstSgt()" class="px-4 py-2 rounded-xl text-[10px] font-black uppercase border-2 transition-all"></button>
                        <button id="next-btn" onclick="sncoChangeStep(1)" class="px-10 py-3 bg-blue-600 text-white rounded-xl text-xs font-black shadow-lg hover:bg-blue-700 transition-all uppercase tracking-widest">Continue <i data-lucide="chevron-right" class="inline-block w-4 h-4 ml-1"></i></button>
                        <div id="final-status-badge" class="hidden px-10 py-3 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg transition-all"></div>
                    </div>
                </div>
            </div>

            <!-- SIDEBAR AUDIT -->
            <div class="lg:col-span-4 flex flex-col h-full no-print">
                <div class="bg-white rounded-[40px] p-8 border border-slate-200 shadow-sm flex-1 flex flex-col max-h-[850px] sticky top-8">
                    <div class="flex items-center gap-2 mb-6 border-b border-slate-50 pb-4">
                        <i data-lucide="layout-dashboard" class="w-5 h-5 text-blue-600"></i>
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Compliance Audit</h3>
                    </div>
                    <div id="audit-results" class="flex-1 space-y-3 custom-scrollbar overflow-y-auto pr-2 max-h-[500px]"></div>
                    <div id="audit-summary-card" class="mt-6 p-6 rounded-3xl border-2 transition-all duration-500 shrink-0">
                        <p class="text-[9px] font-black uppercase text-slate-400 tracking-widest mb-1">Global Verdict</p>
                        <p id="audit-summary-verdict" class="text-xl font-black italic tracking-tighter"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // GLOBAL SELECTOR HELPER
        const el = (id) => document.getElementById(id);

        const guidanceMap = {
            'prof-name': "Enter Candidate Name in 'DOE, JANE A' format.",
            'prof-unit': "Assigned Unit designation.",
            'prof-rank': "Target rank grade.",
            'prof-positionGrade': "Authorized Grade of the candidate's current position slot on the UMD/Alpha Roster.",
            'prof-package': "Standard: Vacancy. STEP: Accelerated.",
            'readiness-submissionDate': "HQ Submission Date determines the fitness currency window.",
            'service-epbDate': "EPB requires 12 months for AGR; 24 months for others.",
            'rev-comments': "Include board findings or waiver justifications.",
            'board-comp-box': "Board must consist of at least 3 members."
        };

        const standards = {
            TSgt: { minTis: 72, minTig: 24, skill: 7, tisLabel: '6 Yrs', pme: [], composition: "2 TSgts and 1 MSgt" },
            MSgt: { minTis: 96, minTig: 24, skill: 7, pme: ['NCOA'], tisLabel: '8 Yrs', composition: "Min 2 MSgts and 1 SMSgt", stepComposition: "Wing CCM + 2 SNCOs" },
            SMSgt: { minTis: 132, minTig: 24, skill: 7, pme: ['SNCOA'], degree: true, tisLabel: '11 Yrs', composition: "Min 2 SMSgts and 1 CMSgt", stepComposition: "State CCM + Wing CCMs" },
            CMSgt: { minTis: 168, minTig: 24, skill: 9, pme: ['SNCOA'], degree: true, tisLabel: '14 Yrs', composition: "3 CMSgts (inc. Wing CCM)", stepComposition: "State CCM + Wing CCMs" },
        };

        let sncoState = {
            currentStep: 1,
            isFirstSgt: false,
            profile: { name: '', unit: '', component: 'DSG', targetRank: 'MSgt', positionGrade: 'MSgt', packageType: 'Standard' },
            reviewer: { name: '', rank: '', unit: '', comments: '' },
            service: { 
                dor: '', payDate: '', tafmsYears: '', tafmsMonths: '', satYears: '', satMonths: '', epbDate: '', pafscLevel: '7', dafscLevel: '7',
                pmeComplete: { NCOA: false, SNCOA: false },
                degreeComplete: false
            },
            readiness: { 
                fitScore: '', fitExpirationDate: '', submissionDate: '', fitStatus: 'Passing',
                clearanceDate: '', adminHolds: { demotion: false, retirement: false, suspended: false } 
            },
            board: { compositionMet: false },
            checklist: { ca26: false, pos_align: false, sou: false, memo: false, epb: false, fit: false, sec_clearance: false, retrain_sou: false, first_sgt_sou: false, af1206: false, bio: false }
        };

        function getEndOfFollowingMonth(dateString) {
            if (!dateString) return null;
            const date = new Date(dateString + 'T00:00:00');
            date.setMonth(date.getMonth() + 2);
            date.setDate(0);
            return date;
        }

        function setupGuidanceSystem() {
            const popup = el('guidance-popup');
            const textEl = el('guidance-text');
            const show = (t) => {
                const text = guidanceMap[t.id];
                if (text && textEl && popup) {
                    textEl.innerText = text;
                    popup.classList.remove('hidden');
                    void popup.offsetHeight;
                    const r = t.getBoundingClientRect();
                    popup.style.left = `${r.left + window.scrollX}px`;
                    popup.style.top = `${r.top + window.scrollY - popup.offsetHeight - 12}px`;
                    popup.classList.add('opacity-100');
                    popup.style.transform = 'translateY(0)';
                }
            };
            const hide = () => { const p = el('guidance-popup'); if (p) { p.classList.remove('opacity-100'); p.style.transform = 'translateY(10px)'; } };
            document.addEventListener('focusin', (e) => { if(e.target.classList.contains('guidance-trigger')) show(e.target); });
            document.addEventListener('mouseover', (e) => {
                const trigger = e.target.closest('.guidance-trigger');
                if (trigger) show(trigger);
            });
            document.addEventListener('focusout', hide);
            document.addEventListener('mouseout', (e) => { if (e.target.closest('.guidance-trigger')) hide(); });
            const p = el('guidance-popup');
            if (p) p.addEventListener('transitionend', () => { if(!p.classList.contains('opacity-100')) p.classList.add('hidden'); });
        }

        function formatYM(totalMonths) {
            if (!totalMonths && totalMonths !== 0) return "0 Yrs 0 Mos";
            const yrs = Math.floor(totalMonths / 12);
            const mos = totalMonths % 12;
            return `${yrs} Yr${yrs !== 1 ? 's' : ''} ${mos} Mo${mos !== 1 ? 's' : ''}`;
        }

        function calcMonths(date) {
            if (!date) return null;
            const d = new Date(date + 'T00:00:00');
            const now = new Date();
            return (now.getFullYear() - d.getFullYear()) * 12 + (now.getMonth() - d.getMonth());
        }

        function sncoUpdateField(cat, field, val) { if (cat && sncoState[cat]) sncoState[cat][field] = val; sncoRender(); }
        function sncoUpdateServiceValue(type, val) {
            const isAGR = sncoState.profile.component === 'AGR';
            const field = isAGR ? (type === 'Years' ? 'tafmsYears' : 'tafmsMonths') : (type === 'Years' ? 'satYears' : 'satMonths');
            sncoState.service[field] = val;
            sncoRender();
        }

        function sncoTogglePME(pme) { sncoState.service.pmeComplete[pme] = !sncoState.service.pmeComplete[pme]; sncoRender(); }
        function sncoToggleDegree() { sncoState.service.degreeComplete = !sncoState.service.degreeComplete; sncoRender(); }
        function sncoChangeStep(dir) { sncoState.currentStep = Math.max(1, Math.min(4, sncoState.currentStep + dir)); sncoRender(); }
        function sncoToggleAdminHold(id) { sncoState.readiness.adminHolds[id] = !sncoState.readiness.adminHolds[id]; sncoRender(); }
        function sncoToggleFirstSgt() { sncoState.isFirstSgt = !sncoState.isFirstSgt; sncoRender(); }
        function sncoToggleComposition() { sncoState.board.compositionMet = !sncoState.board.compositionMet; sncoRender(); }
        function sncoToggleCheck(id) { sncoState.checklist[id] = !sncoState.checklist[id]; sncoRender(); }

        function openPrintPreview() {
            const warnings = sncoGetWarnings();
            const metrics = sncoGetMetrics();
            const isAGR = sncoState.profile.component === 'AGR';
            const s = standards[sncoState.profile.targetRank];
            
            if (el('prev-name')) el('prev-name').innerText = sncoState.profile.name || "UNSPECIFIED";
            if (el('prev-unit')) el('prev-unit').innerText = sncoState.profile.unit || "UNSPECIFIED";
            if (el('prev-rank')) el('prev-rank').innerText = `${sncoState.profile.targetRank} (${sncoState.profile.packageType})`;
            if (el('prev-comments')) el('prev-comments').innerText = sncoState.reviewer.comments || "NO REMARKS PROVIDED";
            
            const isTotalErr = warnings.some(w => w.t === 'error');
            const statusEl = el('prev-status');
            if (statusEl) { statusEl.innerText = isTotalErr ? 'REJECTED' : 'VALIDATED'; statusEl.className = `text-xs font-black ${isTotalErr ? 'text-red-600' : 'text-blue-600'}`; }
            if (el('prev-reviewer-info')) el('prev-reviewer-info').innerText = `${sncoState.reviewer.name || '____________'}, ${sncoState.reviewer.rank || '____'}, ${sncoState.reviewer.unit || '____'}`;

            const rows = [];
            const checkIcon = `<i data-lucide="check" class="w-4 h-4 text-green-600 mx-auto"></i>`;
            const xIcon = `<i data-lucide="x" class="w-4 h-4 text-red-600 mx-auto"></i>`;

            const tisVal = isAGR ? metrics.tafms : metrics.sat;
            const term = isAGR ? 'Service Eligibility (TAFMS)' : 'Service Eligibility (Sat Svc)';
            rows.push({ cat: term, req: `Actual: ${formatYM(tisVal)} / Req: ${s.tisLabel}`, ok: tisVal >= s.minTis });
            rows.push({ cat: 'Time in Grade (TIG)', req: `Actual: ${formatYM(metrics.tig)} / Req: 2 Yrs`, ok: metrics.tig >= 24 || sncoState.profile.targetRank.startsWith('T') });
            
            // POSITION ASSIGNMENT
            const posOk = sncoState.profile.targetRank === sncoState.profile.positionGrade;
            rows.push({ cat: 'Position Authorization', req: `Member in ${sncoState.profile.positionGrade} position slot`, ok: posOk });

            if (s.pme && s.pme.length > 0) {
                const allDone = s.pme.every(p => sncoState.service.pmeComplete[p]);
                rows.push({ cat: `Prof. Military Education (PME)`, req: `Requirement: ${s.pme.join(', ')} completion`, ok: allDone });
            }

            rows.push({ cat: 'Job Qualification (PAFSC)', req: `Level: ${sncoState.service.pafscLevel} / Required: ${s.skill}`, ok: parseInt(sncoState.service.pafscLevel) >= s.skill });
            const epbLimit = isAGR ? 12 : 24;
            rows.push({ cat: 'Performance Cycle (EPB)', req: `Age: ${metrics.epbAge || 0} Mos / Max: ${epbLimit} Mos`, ok: metrics.epbAge !== null && metrics.epbAge <= epbLimit });
            rows.push({ cat: 'Fitness Standards', req: `Status: ${sncoState.readiness.fitStatus} / Score: ${sncoState.readiness.fitScore || 'N/A'}`, ok: sncoState.readiness.fitStatus !== 'Failing' && (parseFloat(sncoState.readiness.fitScore) >= 75 || sncoState.readiness.fitStatus === 'Exempt' || sncoState.readiness.fitStatus === 'Pregnancy') });
            
            const clAgeOk = metrics.clAge !== null && metrics.clAge <= 60;
            rows.push({ cat: 'Security Adjudication', req: `Age: ${metrics.clAge !== null ? metrics.clAge : 0} Mos / Max: 60 Mos`, ok: clAgeOk });

            rows.push({ cat: 'Package Verification', req: `Audit of folder checklist`, ok: !warnings.some(w => w.f === 'File') });

            const tableBody = el('prev-audit-table-body');
            if (tableBody) {
                tableBody.innerHTML = rows.map(r => `
                    <tr>
                        <td class="font-bold text-slate-800">${r.cat}</td>
                        <td class="italic text-slate-500 font-medium">${r.req}</td>
                        <td class="text-center">${r.ok ? checkIcon : xIcon}</td>
                    </tr>
                `).join('');
            }
            
            if (el('print-modal')) el('print-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closePrintPreview() { const m = el('print-modal'); if (m) m.classList.add('hidden'); }

        function sncoGetMetrics() {
            const tis = calcMonths(sncoState.service.payDate);
            const tig = calcMonths(sncoState.service.dor);
            const epbAge = calcMonths(sncoState.service.epbDate);
            const clAge = calcMonths(sncoState.readiness.clearanceDate);
            const tafms = (parseInt(sncoState.service.tafmsYears) || 0) * 12 + (parseInt(sncoState.service.tafmsMonths) || 0);
            const sat = (parseInt(sncoState.service.satYears) || 0) * 12 + (parseInt(sncoState.service.satMonths) || 0);
            const fitTgt = getEndOfFollowingMonth(sncoState.readiness.submissionDate);
            const fitAct = sncoState.readiness.fitExpirationDate ? new Date(sncoState.readiness.fitExpirationDate + 'T00:00:00') : null;
            return { tis, tig, clAge, tafms, sat, fitTgt, fitAct, epbAge };
        }

        function sncoGetWarnings() {
            const m = sncoGetMetrics();
            const s = standards[sncoState.profile.targetRank];
            const isAGR = sncoState.profile.component === 'AGR';
            const pSkill = parseInt(sncoState.service.pafscLevel);
            const dSkill = parseInt(sncoState.service.dafscLevel);
            const reqSkill = s.skill;
            const isRetrain = (pSkill >= reqSkill && dSkill < reqSkill);
            const isStep = sncoState.profile.packageType.startsWith('STEP');
            const isE8E9 = ['SMSgt', 'CMSgt'].includes(sncoState.profile.targetRank);
            const w = [];

            if (!sncoState.profile.name || !sncoState.profile.unit) w.push({ f: 'Incomplete', m: 'Candidate Name/Unit required.', t: 'error' });
            
            // POSITION GRADE ALIGNMENT
            if (sncoState.profile.targetRank !== sncoState.profile.positionGrade) {
                w.push({ f: 'Position Alignment', m: `Hard Stop: Member must be assigned to a ${sncoState.profile.targetRank} position.`, t: 'error' });
            }

            if (pSkill < reqSkill) w.push({ f: 'Skill Level', m: `Needs ${reqSkill}-level PAFSC to promote.`, t: 'error' });
            if (isRetrain) {
                w.push({ f: 'Retraining', m: 'Retraining Promotion detected.', t: 'warning' });
                if (dSkill < 3) w.push({ f: 'Hard Stop', m: 'Ineligible: Needs 3-level in DAFSC.', t: 'error' });
            }
            Object.entries(sncoState.readiness.adminHolds).forEach(([id, active]) => {
                if (active) w.push({ f: 'Hard Stop', m: `Member in ${id} status. Prohibited.`, t: 'error' });
            });
            const tisVal = isAGR ? m.tafms : m.sat;
            const term = isAGR ? 'TAFMS' : 'Satisfactory Service';
            if (tisVal < s.minTis) w.push({ f: 'Eligibility', m: `Needs ${s.tisLabel} ${term}.`, t: 'error' });
            if (m.tig === null) w.push({ f: 'Incomplete', m: 'DOR missing.', t: 'error' });
            else if (m.tig < 24 && !sncoState.profile.targetRank.startsWith('T')) w.push({ f: 'TIG', m: 'Needs 24 Mos.', t: 'error' });
            
            if (m.epbAge !== null) {
                const epbLimit = isAGR ? 12 : 24;
                if (m.epbAge > epbLimit) w.push({ f: 'EPB', m: `Out of Cycle: EPB over ${isAGR ? '1 Yr' : '2 Yrs'}.`, t: 'error' });
            }

            if (sncoState.readiness.fitStatus === 'Failing') w.push({ f: 'Ineligible', m: 'Fitness Failing.', t: 'error' });
            if (m.fitTgt && m.fitAct && m.fitAct < m.fitTgt) w.push({ f: 'Fitness', m: 'Fails currency window.', t: 'error' });
            
            // SECURITY AUDIT LOGIC (5 YEARS / 60 MONTHS)
            if (m.clAge === null) w.push({ f: 'Security', m: 'Security Adjudication Date missing.', t: 'error' });
            else if (m.clAge > 60) w.push({ f: 'Security', m: 'Ineligible: Security Adjudication over 5 years old.', t: 'error' });

            if (s.pme) s.pme.forEach(pme => { if (!sncoState.service.pmeComplete[pme]) w.push({ f: 'PME Missing', m: `Requires ${pme}.`, t: 'error' }); });
            if (s.degree && !sncoState.service.degreeComplete) w.push({ f: 'Education', m: `Requires CCAF.`, t: 'error' });
            if (!sncoState.board.compositionMet) w.push({ f: 'Board', m: 'Not verified.', t: 'error' });
            const checks = [
                {id:'ca26',l:'CA ANG Form 26'},{id:'pos_align',l:'UMD Position Alignment'},{id:'sou',l:'Service SOU (Att 3)'},{id:'memo',l:'Board Letter'},
                {id:'epb',l:'EPB'},{id:'fit',l:'Fitness Printout'},{id:'sec_clearance',l:'Security Memo'},
                {id:'retrain_sou',l:'Retrain SOU',h:!isRetrain},{id:'first_sgt_sou',l:'1st Sgt SOU',h:!sncoState.isFirstSgt},
                {id:'af1206',l:'AF 1206',h:!isStep},
                {id:'bio',l:'Military Biography',h:!(isStep || isE8E9)}
            ];
            checks.forEach(i => { if (!i.h && !sncoState.checklist[i.id]) w.push({ f: 'File', m: `Missing: ${i.l}.`, t: 'error' }); });
            return w;
        }

        function sncoRender() {
            const m = sncoGetMetrics();
            const s = standards[sncoState.profile.targetRank];
            const isAGR = sncoState.profile.component === 'AGR';
            const reqSkill = s.skill;
            const isRetrain = (parseInt(sncoState.service.pafscLevel) >= reqSkill && parseInt(sncoState.service.dafscLevel) < reqSkill);
            const isE8E9 = ['SMSgt', 'CMSgt'].includes(sncoState.profile.targetRank);
            const isStep = sncoState.profile.packageType.startsWith('STEP');

            document.querySelectorAll('.snco-step').forEach((step, i) => { if (step) step.classList.toggle('hidden', i + 1 !== sncoState.currentStep); });
            if (el('stepper-container')) el('stepper-container').innerHTML = ["Identity", "Service", "Readiness", "Verification"].map((l, i) => `<div class="flex flex-col items-center gap-2 flex-1 relative ${sncoState.currentStep >= i+1 ? 'text-blue-600' : 'text-slate-400'}"><div class="w-10 h-10 rounded-full border-2 flex items-center justify-center font-bold transition-all ${sncoState.currentStep >= i+1 ? 'bg-blue-600 text-white border-blue-600' : 'bg-white border-slate-200'}">${sncoState.currentStep > i+1 ? '<i data-lucide="check-circle-2" class="w-6 h-6"></i>' : i+1}</div><span class="text-[10px] font-black uppercase tracking-widest text-center">${l}</span></div>`).join('');

            if (el('tis-label')) el('tis-label').innerText = `Pay Entry Date (Pay Age: ${m.tis !== null ? formatYM(m.tis) : 'N/A'})`;
            if (el('tig-label')) el('tig-label').innerText = `Date of Rank (TIG: ${m.tig !== null ? formatYM(m.tig) : 'N/A'})`;
            if (el('logic-alerts')) el('logic-alerts').classList.toggle('hidden', !isRetrain);
            if (el('slot-req-badge')) el('slot-req-badge').innerText = `${reqSkill}-Level Slot Requirement`;

            const epbInput = el('service-epbDate');
            if (epbInput) {
                const limit = isAGR ? 12 : 24;
                if (m.epbAge !== null && m.epbAge > limit) epbInput.className = "guidance-trigger w-full border-2 rounded-xl p-3 font-bold outline-none bg-red-50 border-red-400 text-red-900 shadow-inner";
                else epbInput.className = "guidance-trigger w-full border-2 rounded-xl p-3 font-bold outline-none bg-slate-50 border-slate-200";
            }

            if (el('row-ncoa')) el('row-ncoa').classList.toggle('hidden', sncoState.profile.targetRank !== 'MSgt');
            if (el('row-sncoa')) el('row-sncoa').classList.toggle('hidden', !['SMSgt', 'CMSgt'].includes(sncoState.profile.targetRank));
            if (el('row-degree')) el('row-degree').classList.toggle('hidden', !['SMSgt', 'CMSgt'].includes(sncoState.profile.targetRank));
            
            if (el('flag-ncoa')) el('flag-ncoa').checked = sncoState.service.pmeComplete.NCOA;
            if (el('flag-sncoa')) el('flag-sncoa').checked = sncoState.service.pmeComplete.SNCOA;
            if (el('flag-degree')) el('flag-degree').checked = sncoState.service.degreeComplete;
            if (el('component-toggle')) el('component-toggle').innerHTML = ['DSG', 'AGR', 'Technician', 'Statutory Tour'].map(c => `<button onclick="sncoUpdateField('profile', 'component', '${c}')" class="flex-1 py-3 text-[10px] font-black rounded-lg transition-all ${sncoState.profile.component === c ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:bg-white/50'}">${c}</button>`).join('');

            const yrsInput = el('service-yrs-input');
            const mosInput = el('service-mos-input');
            const box = el('tafms-container');

            if (box && yrsInput && mosInput) {
                if (isAGR) {
                    box.className = "p-6 rounded-[32px] space-y-4 shadow-xl bg-slate-900 border-blue-500/30 text-white transition-all";
                    el('service-summary-value').innerText = formatYM(m.tafms);
                    el('service-type-label').innerText = "AGR ACTIVE SERVICE (TAFMS)";
                    yrsInput.className = "guidance-trigger w-full rounded-xl p-3 text-xl font-black outline-none bg-slate-800 border-slate-700 text-white";
                    mosInput.className = "guidance-trigger w-full rounded-xl p-3 text-xl font-black outline-none bg-slate-800 border-slate-700 text-white";
                    if (document.activeElement !== yrsInput) yrsInput.value = sncoState.service.tafmsYears;
                    if (document.activeElement !== mosInput) mosInput.value = sncoState.service.tafmsMonths;
                } else {
                    box.className = "p-6 rounded-[32px] space-y-4 shadow-xl bg-white border-slate-200 text-slate-900 transition-all";
                    el('service-summary-value').innerText = formatYM(m.sat);
                    el('service-type-label').innerText = "SATISFACTORY SERVICE (NGB 23)";
                    yrsInput.className = "guidance-trigger w-full rounded-xl p-3 text-xl font-black outline-none bg-slate-50 border-slate-200 text-slate-900 focus:bg-white focus:border-blue-500 transition-all";
                    mosInput.className = "guidance-trigger w-full rounded-xl p-3 text-xl font-black outline-none bg-slate-50 border-slate-200 text-slate-900 focus:bg-white focus:border-blue-500 transition-all";
                    if (document.activeElement !== yrsInput) yrsInput.value = sncoState.service.satYears;
                    if (document.activeElement !== mosInput) mosInput.value = sncoState.service.satMonths;
                }
            }

            const audit = el('audit-results');
            const summaryCard = el('audit-summary-card');
            const verdict = el('audit-summary-verdict');
            const w = sncoGetWarnings();
            const isTotalErr = w.some(item => item.t === 'error');

            if (audit && summaryCard && verdict) {
                if (w.length === 0) {
                    audit.innerHTML = `<div class="flex-1 flex flex-col items-center justify-center py-10 text-center animate-in fade-in"><div class="w-16 h-16 bg-green-50 rounded-full flex items-center justify-center mb-4 shadow-inner ring-4 ring-green-50/50"><i data-lucide="check-circle-2" class="w-8 h-8 text-green-600"></i></div><p class="text-[11px] font-black text-green-900 uppercase italic tracking-widest">Compliant Record</p></div>`;
                    summaryCard.className = "mt-6 p-6 rounded-3xl border-2 bg-green-50 border-green-200 text-green-900 shrink-0";
                    verdict.innerText = "PASS";
                } else {
                    audit.innerHTML = w.map(item => `<div class="p-4 rounded-2xl border flex gap-3 items-start animate-in zoom-in-95 ${item.t === 'error' ? 'bg-red-50 border-red-100 text-red-700' : 'bg-orange-50 border-orange-100 text-orange-700'}"><i data-lucide="${item.t === 'error' ? 'shield-alert' : 'alert-circle'}" class="w-5 h-5 mt-0.5 shrink-0"></i><div><p class="text-[9px] font-black uppercase opacity-60 tracking-widest leading-none">${item.f}</p><p class="text-[10px] font-bold leading-tight">${item.m}</p></div></div>`).join('');
                    summaryCard.className = `mt-6 p-6 rounded-3xl border-2 shrink-0 ${isTotalErr ? 'bg-red-50 border-red-200 text-red-900' : 'bg-orange-50 border-orange-200 text-orange-900'}`;
                    verdict.innerText = isTotalErr ? "FAIL" : "CAUTION";
                }
            }

            const fitExp = el('readiness-fitExpirationDate');
            const tgtLbl = el('fit-currency-target');
            if (fitExp && tgtLbl) {
                if (m.fitTgt) {
                    tgtLbl.innerText = `Required currency through: ${m.fitTgt.toLocaleDateString('en-US', {month:'long', day:'numeric', year:'numeric'})}`;
                    if (m.fitAct && m.fitAct < m.fitTgt) fitExp.className = "guidance-trigger w-full border-2 rounded-xl p-3 font-bold outline-none bg-red-50 border-red-400 text-red-900 shadow-inner";
                    else fitExp.className = "guidance-trigger w-full border-2 rounded-xl p-3 font-bold outline-none bg-slate-50 border-slate-200";
                } else {
                    tgtLbl.innerText = "Enter HQ Submission Date in Step 1...";
                }
            }

            const clrInput = el('clearance-input');
            if (clrInput) {
                clrInput.value = sncoState.readiness.clearanceDate;
                if (m.clAge !== null && m.clAge > 60) clrInput.className = "guidance-trigger w-full border-2 rounded-xl p-3 font-bold outline-none bg-red-50 border-red-400 text-red-900 shadow-inner";
                else clrInput.className = "guidance-trigger w-full border-2 rounded-xl p-3 font-bold outline-none bg-slate-50 border-slate-200";
            }

            if (el('prev-btn')) el('prev-btn').disabled = sncoState.currentStep === 1;

            // Restoring 1st Sgt Toggle and Navigation logic
            const firstSgtBtn = el('first-sgt-btn');
            if (firstSgtBtn) {
                firstSgtBtn.innerText = `1st Sgt Mode: ${sncoState.isFirstSgt ? 'ACTIVE' : 'OFF'}`;
                firstSgtBtn.className = `px-4 py-2 rounded-xl text-[10px] font-black uppercase border-2 transition-all ${sncoState.isFirstSgt ? 'bg-red-600 border-red-600 text-white' : 'bg-white border-slate-200 text-slate-500'}`;
            }

            // NAVIGATION CONSOLIDATION
            const nextBtn = el('next-btn');
            const finalBadge = el('final-status-badge');
            if (nextBtn && finalBadge) {
                if (sncoState.currentStep < 4) {
                    nextBtn.classList.remove('hidden');
                    finalBadge.classList.add('hidden');
                } else {
                    nextBtn.classList.add('hidden');
                    finalBadge.classList.remove('hidden');
                    finalBadge.innerText = isTotalErr ? 'Rejected' : 'Validated for JFHQ';
                    finalBadge.className = `px-10 py-3 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg ${isTotalErr ? 'bg-red-600 text-white' : 'bg-green-600 text-white'}`;
                }
            }

            if (sncoState.currentStep === 4) {
                const checklistEl = el('folder-checklist');
                const items = [
                    {id:'ca26',l:'CA ANG Form 26'},{id:'pos_align',l:'UMD Position Alignment'},{id:'sou',l:'Service SOU (Att 3)'},{id:'memo',l:'Board Letter'},
                    {id:'epb',l:'EPB'},{id:'fit',l:'Fitness Printout'},{id:'sec_clearance',l:'Security Memo'},
                    {id:'retrain_sou',l:'Retrain SOU',h:!isRetrain},{id:'first_sgt_sou',l:'1st Sgt SOU',h:!sncoState.isFirstSgt},
                    {id:'af1206',l:'AF 1206',h:!isStep},
                    {id:'bio',l:'Military Biography',h:!(isStep || isE8E9)}
                ];
                if (checklistEl) checklistEl.innerHTML = items.filter(i=>!i.h).map(i=>`<div onclick="sncoToggleCheck('${i.id}')" class="h-16 p-3 rounded-2xl border-2 flex items-center justify-between cursor-pointer transition-all ${sncoState.checklist[i.id]?'bg-blue-600 border-blue-600 text-white':'bg-white border-slate-100'}"><span class="text-[9px] font-black uppercase tracking-tight leading-tight pr-2">${i.l}</span>${sncoState.checklist[i.id]?'<i data-lucide="check-circle-2" class="w-4 h-4 text-white"></i>':'<div class="w-4 h-4 rounded-full border-2 border-slate-200"></div>'}</div>`).join('');
                if (el('board-req-text')) el('board-req-text').innerText = isStep ? s.stepComposition : s.composition;
                if (el('board-comp-checkbox')) el('board-comp-checkbox').checked = sncoState.board.compositionMet;
                if (el('rev-name')) el('rev-name').value = sncoState.reviewer.name;
                if (el('rev-rank')) el('rev-rank').value = sncoState.reviewer.rank;
                if (el('rev-unit')) el('rev-unit').value = sncoState.reviewer.unit;
                if (el('rev-comments')) el('rev-comments').value = sncoState.reviewer.comments;
                
                if (el('prof-positionGrade')) el('prof-positionGrade').value = sncoState.profile.positionGrade;
                if (el('prof-rank')) el('prof-rank').value = sncoState.profile.targetRank;
            }
            lucide.createIcons();
        }

        window.onload = function() { setupGuidanceSystem(); sncoRender(); }
    </script>
</body>
</html> eof
