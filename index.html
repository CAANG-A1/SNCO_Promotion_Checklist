<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNCO Promotion Review Terminal</title>
    <!-- Core Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f1f5f9;
            position: relative;
        }

        @media print {
            .no-print { display: none !important; }
            body { background: white !important; padding: 0 !important; color: black !important; }
            .print-only { display: block !important; }
            .max-w-6xl { max-width: none !important; width: 100% !important; margin: 0 !important; }
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        #guidance-popup {
            pointer-events: none;
            transition: opacity 0.2s ease-in-out, transform 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 5000;
            transform: translateY(10px);
        }

        .modal-overlay {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="text-slate-900 min-h-screen p-4 md:p-8">

    <!-- FLOATING GUIDANCE POPUP -->
    <div id="guidance-popup" class="hidden opacity-0 absolute bg-slate-900 text-white p-4 rounded-2xl shadow-2xl max-w-xs text-[11px] font-medium leading-relaxed border border-white/10 no-print">
        <div class="flex items-center gap-2 mb-2 border-b border-white/10 pb-2">
            <i data-lucide="info" class="w-4 h-4 text-blue-400"></i>
            <span class="font-black uppercase tracking-widest text-blue-400">Policy Guidance</span>
        </div>
        <p id="guidance-text" class="text-slate-300"></p>
        <div class="absolute left-6 -bottom-2 w-4 h-4 bg-slate-900 rotate-45 border-r border-b border-white/10"></div>
    </div>

    <!-- PRINT PREVIEW MODAL -->
    <div id="print-modal" class="hidden fixed inset-0 z-[2000] flex items-center justify-center p-4 md:p-12 modal-overlay no-print">
        <div class="bg-slate-50 w-full max-w-5xl h-full rounded-[40px] shadow-2xl overflow-hidden flex flex-col animate-in zoom-in-95 duration-300">
            <div class="p-6 border-b border-slate-200 flex justify-between items-center bg-white">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-blue-600 rounded-lg text-white"><i data-lucide="file-text" class="w-5 h-5"></i></div>
                    <h2 class="font-black uppercase italic tracking-tighter">Document Preview</h2>
                </div>
                <div class="flex gap-3">
                    <button onclick="closePrintPreview()" class="px-6 py-2 rounded-xl text-xs font-bold text-slate-500 hover:bg-slate-100 transition-all uppercase tracking-widest">Close</button>
                    <button onclick="window.print()" class="px-8 py-2 bg-blue-600 text-white rounded-xl text-xs font-black shadow-lg hover:bg-blue-700 transition-all uppercase tracking-widest flex items-center gap-2">
                        <i data-lucide="printer" class="w-4 h-4"></i> Finalize & Print
                    </button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-12 bg-slate-200/50 flex justify-center custom-scrollbar">
                <div class="bg-white w-[8.5in] min-h-[11in] shadow-2xl p-16 space-y-12 uppercase text-slate-900">
                    <div class="text-center border-b-4 border-slate-900 pb-8">
                        <h2 class="text-3xl font-black italic tracking-tighter underline decoration-blue-600 underline-offset-8">Promotion Certification</h2>
                        <p class="text-[10px] font-bold tracking-[0.2em] mt-4 opacity-50">California Air National Guard | Official Review Record</p>
                    </div>

                    <div class="grid grid-cols-2 gap-8 font-black border-b border-slate-100 pb-8">
                        <div class="space-y-4">
                            <div><p class="text-[9px] text-slate-400 mb-0.5">Candidate</p><p id="prev-name" class="text-xs font-black"></p></div>
                            <div><p class="text-[9px] text-slate-400 mb-0.5">Target Rank</p><p id="prev-rank" class="text-xs font-black"></p></div>
                        </div>
                        <div class="space-y-4">
                            <div><p class="text-[9px] text-slate-400 mb-0.5">Assigned Unit</p><p id="prev-unit" class="text-xs font-black"></p></div>
                            <div><p class="text-[9px] text-slate-400 mb-0.5">Review Status</p><p id="prev-status" class="text-xs font-black"></p></div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <h3 class="text-xs font-black border-l-4 border-blue-600 pl-3">Audit Summary</h3>
                        <div id="prev-audit-list" class="space-y-2"></div>
                    </div>

                    <div class="pt-24 grid grid-cols-2 gap-16">
                        <div class="space-y-12">
                            <div class="border-b-2 border-slate-900 pb-2"><p class="text-[10px] font-bold text-slate-400">Reviewer Name/Rank</p></div>
                            <div class="border-b-2 border-slate-900 pb-2"><p class="text-[10px] font-bold text-slate-400">Digital Signature / Date</p></div>
                        </div>
                        <div class="bg-slate-50 border-2 border-dashed border-slate-200 rounded-3xl flex flex-col items-center justify-center p-8 text-center">
                            <i data-lucide="shield-check" class="w-12 h-12 text-slate-200 mb-4"></i>
                            <p class="text-[10px] font-bold text-slate-300">Official Stamp Area</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto space-y-6">
        <header class="bg-white rounded-[32px] shadow-sm border border-slate-200 p-6 flex justify-between items-center no-print">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-slate-900 rounded-2xl flex items-center justify-center text-white">
                    <i data-lucide="shield-check" class="w-8 h-8"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-black tracking-tight uppercase italic tracking-tighter leading-none">SNCO Promotion Terminal</h1>
                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">California Air National Guard | Compliance Engine</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="openPrintPreview()" class="px-6 py-2.5 bg-blue-600 text-white hover:bg-blue-700 rounded-xl text-xs font-black flex items-center gap-2 uppercase tracking-widest transition-all shadow-lg shadow-blue-900/10">
                    <i data-lucide="printer" class="w-4 h-4"></i> Print Review
                </button>
                <button onclick="location.reload()" class="p-3 text-slate-400 hover:text-red-500 transition-colors">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <div class="bg-white rounded-[32px] shadow-sm border border-slate-200 p-8 no-print">
            <div id="stepper-container" class="flex justify-between items-start max-w-3xl mx-auto"></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-stretch no-print">
            <div class="lg:col-span-8 bg-white rounded-[40px] shadow-sm border border-slate-200 flex flex-col overflow-hidden relative">
                <div class="flex-1 p-8 md:p-12">
                    <!-- STEP 1: IDENTITY -->
                    <div id="step-1" class="snco-step space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                        <div class="border-b border-slate-100 pb-4">
                            <h2 class="text-2xl font-black tracking-tight uppercase italic tracking-tighter">1. Member Identification</h2>
                            <p class="text-slate-500 text-sm italic">Define candidate logic and component status.</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Candidate Name</label>
                                <input type="text" id="prof-name" oninput="sncoUpdateField('profile', 'name', this.value)" class="guidance-trigger w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 font-bold uppercase outline-none focus:ring-2 focus:ring-blue-500" placeholder="DOE, JANE A">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Assigned Unit</label>
                                <input type="text" id="prof-unit" oninput="sncoUpdateField('profile', 'unit', this.value)" class="guidance-trigger w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 font-bold uppercase outline-none focus:ring-2 focus:ring-blue-500" placeholder="144 FW / FSS">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Target Rank</label>
                                <select id="prof-rank" onchange="sncoUpdateField('profile', 'targetRank', this.value)" class="guidance-trigger w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 font-bold outline-none">
                                    <option value="TSgt">TSgt (E-6)</option>
                                    <option value="MSgt" selected>MSgt (E-7)</option>
                                    <option value="SMSgt">SMSgt (E-8)</option>
                                    <option value="CMSgt">CMSgt (E-9)</option>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Program Logic</label>
                                <select id="prof-package" onchange="sncoUpdateField('profile', 'packageType', this.value)" class="guidance-trigger w-full border-2 bg-slate-50 border-slate-200 rounded-2xl p-4 font-bold outline-none text-blue-600">
                                    <option value="Standard">Standard Vacancy</option>
                                    <option value="STEP_I">STEP I (E6/E7)</option>
                                    <option value="STEP_II">STEP II (E8/E9)</option>
                                    <option value="Retraining">Retraining Promotion</option>
                                </select>
                            </div>
                            <div class="space-y-2 md:col-span-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Component Status</label>
                                <div id="component-toggle" class="flex bg-slate-100 rounded-xl p-1 gap-1"></div>
                            </div>
                        </div>
                        <div id="step1-extra" class="hidden p-6 bg-purple-50 rounded-3xl border border-purple-100 space-y-4">
                            <h3 class="text-xs font-black uppercase text-purple-800 tracking-widest flex items-center gap-2"><i data-lucide="star" class="w-4 h-4"></i> STEP Program Controls</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="flex items-center justify-between p-3 bg-white rounded-xl border border-purple-200 cursor-pointer" onclick="sncoToggleStepFlag('isSoleOccupant')">
                                    <span class="text-[10px] font-bold text-slate-700">Sole Occupant?</span>
                                    <input type="checkbox" id="flag-sole" class="w-5 h-5 rounded text-purple-600 pointer-events-none">
                                </div>
                                <div class="flex items-center justify-between p-3 bg-white rounded-xl border border-purple-200 cursor-pointer" onclick="sncoToggleStepFlag('priorStepToGrade')">
                                    <span class="text-[10px] font-bold text-slate-700">Prior STEP?</span>
                                    <input type="checkbox" id="flag-prior" class="w-5 h-5 rounded text-purple-600 pointer-events-none">
                                </div>
                            </div>
                            <textarea id="prof-fmp" oninput="sncoUpdateField('stepFlags', 'fmpRemarks', this.value)" class="guidance-trigger w-full bg-white border border-purple-200 rounded-xl p-3 text-xs min-h-[80px] outline-none" placeholder="Force Management Plan remarks..."></textarea>
                        </div>
                    </div>

                    <!-- STEP 2: SERVICE -->
                    <div id="step-2" class="snco-step hidden space-y-6 animate-in fade-in slide-in-from-right-4 duration-500">
                        <div class="border-b border-slate-100 pb-4">
                            <h2 class="text-2xl font-black tracking-tight uppercase tracking-tighter italic leading-none">2. Service Verification</h2>
                            <p class="text-slate-500 text-sm">Table 10.1 Service and active duty (TAFMS) data.</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="space-y-4">
                                <div class="space-y-1">
                                    <label id="tis-label" class="text-[10px] font-black text-slate-400 uppercase tracking-widest"></label>
                                    <input type="date" id="service-payDate" oninput="sncoUpdateField('service', 'payDate', this.value)" class="guidance-trigger w-full bg-slate-50 border border-slate-200 rounded-2xl p-3 text-sm font-bold outline-none">
                                </div>
                                <div class="space-y-1">
                                    <label id="tig-label" class="text-[10px] font-black text-slate-400 uppercase tracking-widest"></label>
                                    <input type="date" id="service-dor" oninput="sncoUpdateField('service', 'dor', this.value)" class="guidance-trigger w-full bg-slate-50 border border-slate-200 rounded-2xl p-3 text-sm font-bold outline-none">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] font-black text-blue-600 uppercase tracking-widest italic block mb-1">Latest EPB Closeout Date</label>
                                    <input type="date" id="service-epbDate" oninput="sncoUpdateField('service', 'epbDate', this.value)" class="guidance-trigger w-full bg-blue-50 border border-blue-100 rounded-2xl p-3 text-sm font-bold outline-none">
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div id="tafms-container" class="p-6 rounded-[32px] space-y-4 shadow-xl border-2 transition-all">
                                    <div class="flex justify-between items-center border-b border-white/10 pb-2">
                                        <span id="service-type-label" class="text-[9px] font-black uppercase"></span>
                                        <span id="service-summary-value" class="font-black text-xs"></span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="text-[9px] font-bold uppercase opacity-50 mb-1 block">Years</label>
                                            <input type="number" id="service-yrs-input" oninput="sncoUpdateServiceValue('Years', this.value)" class="guidance-trigger w-full rounded-xl p-3 text-xl font-black outline-none border-2">
                                        </div>
                                        <div>
                                            <label class="text-[9px] font-bold uppercase opacity-50 mb-1 block">Months</label>
                                            <input type="number" id="service-mos-input" oninput="sncoUpdateServiceValue('Months', this.value)" class="guidance-trigger w-full rounded-xl p-3 text-xl font-black outline-none border-2" max="11">
                                        </div>
                                    </div>
                                </div>
                                <div class="p-4 bg-slate-50 rounded-3xl border border-slate-200 grid grid-cols-2 gap-4">
                                    <div class="space-y-1"><label class="text-[9px] font-bold text-slate-500 uppercase">PAFSC</label><select onchange="sncoUpdateField('service', 'pafscLevel', this.value)" class="w-full bg-white border border-slate-200 rounded-xl p-2 text-xs font-black"><option value="3">3</option><option value="5">5</option><option value="7" selected>7</option><option value="9">9</option></select></div>
                                    <div class="space-y-1"><label class="text-[9px] font-bold text-slate-500 uppercase">DAFSC</label><select onchange="sncoUpdateField('service', 'dafscLevel', this.value)" class="w-full bg-white border border-slate-200 rounded-xl p-2 text-xs font-black"><option value="1">1</option><option value="3">3</option><option value="5">5</option><option value="7" selected>7</option><option value="9">9</option></select></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 3: READINESS -->
                    <div id="step-3" class="snco-step hidden space-y-6 animate-in fade-in slide-in-from-right-4 duration-500">
                        <div class="border-b border-slate-100 pb-4">
                            <h2 class="text-2xl font-black tracking-tight uppercase tracking-tighter italic leading-none">3. Readiness & Administrative</h2>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Fit Score</label><input type="number" id="readiness-fitScore" oninput="sncoUpdateField('readiness', 'fitScore', this.value)" class="guidance-trigger w-full bg-slate-50 border border-slate-200 rounded-xl p-3 font-bold outline-none"></div>
                                    <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Date Taken</label><input type="date" id="readiness-fitDate" oninput="sncoUpdateField('readiness', 'fitDate', this.value)" class="guidance-trigger w-full bg-slate-50 border border-slate-200 rounded-xl p-3 font-bold outline-none"></div>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Security Adjudication Date</label>
                                    <input type="date" id="clearance-input" oninput="sncoUpdateField('readiness', 'clearanceDate', this.value)" class="guidance-trigger w-full border-2 rounded-xl p-3 font-bold outline-none bg-slate-50 border-slate-200">
                                </div>
                            </div>
                            <div class="bg-slate-50 p-6 rounded-[32px] border border-slate-200 space-y-4 shadow-inner">
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest border-b pb-2 leading-none">Admin Barriers</p>
                                <div id="admin-flags" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 4: VERIFICATION -->
                    <div id="step-4" class="snco-step hidden space-y-6 animate-in fade-in slide-in-from-right-4 duration-500">
                        <div class="border-b border-slate-100 pb-4">
                            <h2 class="text-2xl font-black tracking-tight uppercase tracking-tighter italic leading-none">4. Verification & Summary</h2>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 bg-slate-50 p-8 rounded-[40px] border border-slate-200 shadow-inner">
                            <div class="lg:col-span-5 space-y-6">
                                <h3 class="font-black text-xs uppercase text-blue-600 flex items-center gap-3"><i data-lucide="gavel" class="w-5 h-5"></i> Board Check</h3>
                                <div class="p-6 bg-white rounded-[32px] border border-slate-200 shadow-sm flex items-center justify-between cursor-pointer" onclick="sncoToggleComposition()">
                                    <div class="space-y-1">
                                        <p class="text-[10px] font-black uppercase text-slate-700 tracking-tighter">Composition OK?</p>
                                        <p id="board-req-text" class="text-[9px] text-slate-400 italic font-medium leading-none"></p>
                                    </div>
                                    <input type="checkbox" id="board-comp-checkbox" class="w-6 h-6 rounded-md text-blue-600 pointer-events-none">
                                </div>
                            </div>
                            <div class="lg:col-span-7 space-y-6">
                                <h3 class="font-black text-xs uppercase text-blue-600 flex items-center gap-3"><i data-lucide="clipboard-list" class="w-5 h-5"></i> Folder Verification</h3>
                                <div id="folder-checklist" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NAVIGATION FOOTER -->
                <div class="bg-slate-50 p-6 border-t border-slate-100 flex justify-between items-center">
                    <button id="prev-btn" onclick="sncoChangeStep(-1)" class="px-8 py-3 text-xs font-black text-slate-400 uppercase tracking-widest hover:text-slate-600 transition-colors">
                        <i data-lucide="chevron-left" class="inline-block w-4 h-4 mr-1"></i> Back
                    </button>
                    <div class="flex gap-4">
                        <button id="first-sgt-btn" onclick="sncoToggleFirstSgt()" class="px-4 py-2 rounded-xl text-[10px] font-black uppercase border-2 transition-all"></button>
                        <button id="next-btn" onclick="sncoChangeStep(1)" class="px-10 py-3 bg-blue-600 text-white rounded-xl text-xs font-black shadow-lg hover:bg-blue-700 transition-all uppercase tracking-widest">Continue <i data-lucide="chevron-right" class="inline-block w-4 h-4 ml-1"></i></button>
                        <div id="final-status-badge" class="hidden px-10 py-3 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg transition-all"></div>
                    </div>
                </div>
            </div>

            <!-- SIDEBAR AUDIT -->
            <div class="lg:col-span-4 flex flex-col h-full">
                <div class="bg-white rounded-[40px] p-8 border border-slate-200 shadow-sm flex-1 flex flex-col">
                    <div class="flex items-center gap-2 mb-6 border-b border-slate-50 pb-4">
                        <i data-lucide="layout-dashboard" class="w-5 h-5 text-blue-600"></i>
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Compliance Audit</h3>
                    </div>
                    <div id="audit-results" class="flex-1 space-y-3 custom-scrollbar overflow-y-auto pr-2"></div>
                    <div id="audit-summary-card" class="mt-6 p-6 rounded-3xl border-2 transition-all duration-500">
                        <p class="text-[9px] font-black uppercase text-slate-400 tracking-widest mb-1">Global Verdict</p>
                        <p id="audit-summary-verdict" class="text-xl font-black italic tracking-tighter"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const guidanceMap = {
            'prof-name': "Enter Candidate Name in 'DOE, JANE A' format. Ensure spelling matches the Alpha Roster.",
            'prof-unit': "Assigned Unit designation. Ensure correct Wing/Group/Squadron is identified for Board alignment.",
            'prof-rank': "Select target promotion grade. Note: TSgt (72 Mo TIS), MSgt (96 Mo TIS), SMSgt (132 Mo TIS), CMSgt (168 Mo TIS).",
            'prof-package': "Standard: Vacancy Hire. STEP: Accelerated Promotion. Retraining: Promoting into new AFSC.",
            'prof-fmp': "Identify specific Force Management Plan justifications if applicable. Mandatory for STEP packages.",
            'service-payDate': "Pay Entry Base Date (PEBD). Used to calculate Satisfactory Service years. Critical for NGB 23 audit.",
            'service-dor': "Current Date of Rank. SNCO promotions generally require 24 months Time-In-Grade (TIG).",
            'service-epbDate': "Latest EPB Closeout. EPBs must be current (within cycle) to validate promotion eligibility.",
            'service-yrs-input': "Total Years of Satisfactory Service (Points) from NGB 23 or TAFMS (AGR).",
            'service-mos-input': "Remaining months toward the next year of service.",
            'readiness-fitScore': "Current PFA Score. Must be 75.0 or higher.",
            'readiness-fitDate': "Date of most recent PFA. The validity period starts from the date taken.",
            'clearance-input': "Security Clearance Adjudication Date. Must be within 5 years."
        };

        const standards = {
            TSgt: { minTis: 72, minTig: 24, skill: 7, tisLabel: '6 Yrs', tigLabel: '2 Yrs', composition: "2 TSgts and 1 MSgt" },
            MSgt: { minTis: 96, minTig: 24, skill: 7, tisLabel: '8 Yrs', tigLabel: '2 Yrs', composition: "Min 2 MSgts and 1 SMSgt", stepComposition: "Wing CCM + 2 SNCOs" },
            SMSgt: { minTis: 132, minTig: 24, skill: 7, tisLabel: '11 Yrs', tigLabel: '2 Yrs', composition: "Min 2 SMSgts and 1 CMSgt", stepComposition: "State CCM + Wing CCMs" },
            CMSgt: { minTis: 168, minTig: 24, skill: 9, tisLabel: '14 Yrs', tigLabel: '2 Yrs', composition: "3 CMSgts (inc. Wing CCM)", stepComposition: "State CCM + Wing CCMs" },
        };

        let sncoState = {
            currentStep: 1,
            isFirstSgt: false,
            profile: { name: '', unit: '', component: 'AGR', targetRank: 'MSgt', packageType: 'Standard' },
            service: { dor: '', payDate: '', tafmsYears: '', tafmsMonths: '', satYears: '', satMonths: '', epbDate: '', pafscLevel: '7', dafscLevel: '7' },
            stepFlags: { isSoleOccupant: false, priorStepToGrade: false, fmpRemarks: '' },
            readiness: { fitScore: '', fitDate: '', clearanceDate: '', adminHolds: { demotion: false, retirement: false, suspended: false } },
            board: { compositionMet: false },
            checklist: { ca26: false, sou: false, memo: false, epb: false, fit: false, sec_clearance: false, retrain_sou: false, first_sgt_sou: false }
        };

        function setupGuidanceSystem() {
            const popup = document.getElementById('guidance-popup');
            const textEl = document.getElementById('guidance-text');
            document.addEventListener('focusin', (e) => {
                if (e.target.classList.contains('guidance-trigger')) {
                    const text = guidanceMap[e.target.id];
                    if (text) {
                        textEl.innerText = text;
                        popup.classList.remove('hidden');
                        void popup.offsetHeight; 
                        const rect = e.target.getBoundingClientRect();
                        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                        const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
                        popup.style.left = `${rect.left + scrollLeft}px`;
                        popup.style.top = `${rect.top + scrollTop - popup.offsetHeight - 12}px`;
                        popup.classList.add('opacity-100');
                        popup.style.transform = 'translateY(0)';
                    }
                }
            });
            document.addEventListener('focusout', (e) => {
                if (e.target.classList.contains('guidance-trigger')) {
                    popup.classList.remove('opacity-100');
                    popup.style.transform = 'translateY(10px)';
                }
            });
            popup.addEventListener('transitionend', (e) => {
                if (e.propertyName === 'opacity' && !popup.classList.contains('opacity-100')) {
                    popup.classList.add('hidden');
                }
            });
        }

        function formatYM(totalMonths) {
            if (!totalMonths && totalMonths !== 0) return "N/A";
            const yrs = Math.floor(totalMonths / 12);
            const mos = totalMonths % 12;
            return `${yrs} Yr${yrs !== 1 ? 's' : ''} ${mos} Mo${mos !== 1 ? 's' : ''}`;
        }

        function calcMonths(date) {
            if (!date) return null;
            const d = new Date(date + 'T00:00:00');
            const now = new Date();
            return (now.getFullYear() - d.getFullYear()) * 12 + (now.getMonth() - d.getMonth());
        }

        function sncoUpdateField(category, field, value) {
            if (category) sncoState[category][field] = value;
            sncoRender();
        }

        function sncoUpdateServiceValue(type, value) {
            const isAGR = sncoState.profile.component === 'AGR';
            const field = isAGR ? (type === 'Years' ? 'tafmsYears' : 'tafmsMonths') : (type === 'Years' ? 'satYears' : 'satMonths');
            sncoState.service[field] = value;
            sncoRender();
        }

        function sncoChangeStep(dir) {
            sncoState.currentStep = Math.max(1, Math.min(4, sncoState.currentStep + dir));
            sncoRender();
        }

        function sncoToggleStepFlag(flag) {
            sncoState.stepFlags[flag] = !sncoState.stepFlags[flag];
            sncoRender();
        }

        function sncoToggleAdminHold(id) {
            sncoState.readiness.adminHolds[id] = !sncoState.readiness.adminHolds[id];
            sncoRender();
        }

        function sncoToggleFirstSgt() {
            sncoState.isFirstSgt = !sncoState.isFirstSgt;
            sncoRender();
        }

        function sncoToggleComposition() {
            sncoState.board.compositionMet = !sncoState.board.compositionMet;
            sncoRender();
        }

        function sncoToggleCheck(id) {
            sncoState.checklist[id] = !sncoState.checklist[id];
            sncoRender();
        }

        function openPrintPreview() {
            const warnings = sncoGetWarnings();
            const isErr = warnings.some(w => w.t === 'error');
            document.getElementById('prev-name').innerText = sncoState.profile.name || "UNSPECIFIED";
            document.getElementById('prev-unit').innerText = sncoState.profile.unit || "UNSPECIFIED";
            document.getElementById('prev-rank').innerText = `${sncoState.profile.targetRank} (${sncoState.profile.packageType})`;
            const statusEl = document.getElementById('prev-status');
            statusEl.innerText = isErr ? 'REJECTED' : 'VALIDATED';
            statusEl.className = `text-xs font-black ${isErr ? 'text-red-600' : 'text-blue-600'}`;
            const auditList = document.getElementById('prev-audit-list');
            auditList.innerHTML = warnings.length === 0 ? `<p class="text-[9px] font-bold text-green-600">FULLY COMPLIANT PACKAGE</p>` : warnings.map(w => `<div class="flex items-start gap-2 py-1"><span class="w-1 h-1 rounded-full mt-1.5 ${w.t === 'error' ? 'bg-red-600' : 'bg-orange-500'}"></span><p class="text-[9px]"><span class="font-black">${w.f}:</span> ${w.m}</p></div>`).join('');
            document.getElementById('print-modal').classList.remove('hidden');
        }

        function closePrintPreview() { document.getElementById('print-modal').classList.add('hidden'); }

        function sncoGetMetrics() {
            const tis = calcMonths(sncoState.service.payDate);
            const tig = calcMonths(sncoState.service.dor);
            const clearanceAge = calcMonths(sncoState.readiness.clearanceDate);
            let fitExpiration = null;
            if (sncoState.readiness.fitDate && sncoState.readiness.fitScore) {
                const testDate = new Date(sncoState.readiness.fitDate + 'T00:00:00');
                const validityMonths = parseFloat(sncoState.readiness.fitScore) >= 90 ? 12 : 6;
                fitExpiration = new Date(testDate.getFullYear(), testDate.getMonth() + validityMonths + 1, 0);
            }
            const tafms = (parseInt(sncoState.service.tafmsYears) || 0) * 12 + (parseInt(sncoState.service.tafmsMonths) || 0);
            const sat = (parseInt(sncoState.service.satYears) || 0) * 12 + (parseInt(sncoState.service.satMonths) || 0);
            return { tis, tig, clearanceAge, fitExpiration, tafms, sat };
        }

        function sncoGetWarnings() {
            const metrics = sncoGetMetrics();
            const s = standards[sncoState.profile.targetRank];
            // FIXED RETRAINING LOGIC: Detects manually selected "Retraining" OR data mismatch
            const isRetraining = (sncoState.profile.packageType === 'Retraining') || (parseInt(sncoState.service.pafscLevel) >= s.skill && parseInt(sncoState.service.dafscLevel) < s.skill);
            const isAGR = sncoState.profile.component === 'AGR';
            const warnings = [];

            if (!sncoState.profile.name || !sncoState.profile.unit) warnings.push({ f: 'Incomplete', m: 'Candidate Name/Unit is required.', t: 'error' });
            if (isRetraining) warnings.push({ f: 'Retraining', m: 'Para 10.12 Retraining detected. SOU mandatory.', t: 'warning' });
            if (metrics.sat < s.minTis) warnings.push({ f: 'Eligibility', m: `Needs ${s.tisLabel} Satisfactory Service. Current: ${formatYM(metrics.sat)}.`, t: 'error' });
            if (metrics.tig === null) warnings.push({ f: 'Incomplete', m: 'Date of Rank missing.', t: 'error' });
            else if (metrics.tig < 24 && !sncoState.profile.targetRank.startsWith('T')) warnings.push({ f: 'TIG', m: 'Needs 24 Mos TIG.', t: 'error' });
            if (!sncoState.service.epbDate) warnings.push({ f: 'Incomplete', m: 'EPB Closeout Date required.', t: 'error' });
            if (isAGR && !metrics.tafms) warnings.push({ f: 'TAFMS', m: 'AGR Active Duty service must be entered.', t: 'error' });
            if (!sncoState.readiness.fitScore) warnings.push({ f: 'Incomplete', m: 'Fitness data missing.', t: 'error' });
            if (!sncoState.readiness.clearanceDate) warnings.push({ f: 'Security', m: 'Adjudication Date missing.', t: 'error' });
            if (!sncoState.board.compositionMet) warnings.push({ f: 'Board', m: 'Composition not verified.', t: 'error' });
            
            return warnings;
        }

        function sncoRender() {
            const metrics = sncoGetMetrics();
            const s = standards[sncoState.profile.targetRank];
            // FIXED RETRAINING LOGIC: Triggers on manual selection OR data mismatch
            const isRetraining = (sncoState.profile.packageType === 'Retraining') || (parseInt(sncoState.service.pafscLevel) >= s.skill && parseInt(sncoState.service.dafscLevel) < s.skill);
            const isAGR = sncoState.profile.component === 'AGR';

            document.querySelectorAll('.snco-step').forEach((el, i) => el.classList.toggle('hidden', i + 1 !== sncoState.currentStep));
            const stepper = document.getElementById('stepper-container');
            stepper.innerHTML = ["Identity", "Service", "Readiness", "Verification"].map((l, i) => `<div class="flex flex-col items-center gap-2 flex-1 relative ${sncoState.currentStep >= i+1 ? 'text-blue-600' : 'text-slate-400'}"><div class="w-10 h-10 rounded-full border-2 flex items-center justify-center font-bold transition-all ${sncoState.currentStep >= i+1 ? 'bg-blue-600 text-white border-blue-600' : 'bg-white border-slate-200'}">${sncoState.currentStep > i+1 ? '<i data-lucide="check-circle-2" class="w-6 h-6"></i>' : i+1}</div><span class="text-[10px] font-black uppercase tracking-widest text-center">${l}</span></div>`).join('');

            document.getElementById('tis-label').innerText = `Pay Entry Date (Pay Age: ${metrics.tis !== null ? formatYM(metrics.tis) : 'N/A'})`;
            document.getElementById('tig-label').innerText = `Date of Rank (TIG: ${metrics.tig !== null ? formatYM(metrics.tig) : 'N/A'})`;
            document.getElementById('step1-extra').classList.toggle('hidden', !sncoState.profile.packageType.startsWith('STEP'));
            document.getElementById('flag-sole').checked = sncoState.stepFlags.isSoleOccupant;
            document.getElementById('flag-prior').checked = sncoState.stepFlags.priorStepToGrade;
            
            const componentToggle = document.getElementById('component-toggle');
            componentToggle.innerHTML = ['DSG', 'AGR', 'Technician', 'Statutory Tour'].map(c => `<button onclick="sncoUpdateField('profile', 'component', '${c}')" class="flex-1 py-3 text-[10px] font-black rounded-lg transition-all ${sncoState.profile.component === c ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:bg-white/50'}">${c}</button>`).join('');

            const tafmsContainer = document.getElementById('tafms-container');
            const yrsInput = document.getElementById('service-yrs-input');
            const mosInput = document.getElementById('service-mos-input');
            const summaryVal = document.getElementById('service-summary-value');
            const typeLabel = document.getElementById('service-type-label');

            if (isAGR) {
                tafmsContainer.className = "p-6 rounded-[32px] space-y-4 shadow-xl transition-all bg-slate-900 border-blue-500/30 text-white";
                typeLabel.innerText = "AGR ACTIVE SERVICE (TAFMS)";
                summaryVal.innerText = formatYM(metrics.tafms);
                yrsInput.className = "guidance-trigger w-full rounded-xl p-3 text-xl font-black outline-none bg-slate-800 border-slate-700 text-white";
                mosInput.className = "guidance-trigger w-full rounded-xl p-3 text-xl font-black outline-none bg-slate-800 border-slate-700 text-white";
                if (document.activeElement !== yrsInput) yrsInput.value = sncoState.service.tafmsYears;
                if (document.activeElement !== mosInput) mosInput.value = sncoState.service.tafmsMonths;
            } else {
                tafmsContainer.className = "p-6 rounded-[32px] space-y-4 shadow-xl transition-all bg-white border-slate-200 text-slate-900";
                typeLabel.innerText = "SATISFACTORY SERVICE (NGB 23)";
                summaryVal.innerText = formatYM(metrics.sat);
                yrsInput.className = "guidance-trigger w-full rounded-xl p-3 text-xl font-black outline-none bg-slate-50 border-slate-200 text-slate-900 focus:bg-white focus:border-blue-500 transition-all";
                mosInput.className = "guidance-trigger w-full rounded-xl p-3 text-xl font-black outline-none bg-slate-50 border-slate-200 text-slate-900 focus:bg-white focus:border-blue-500 transition-all";
                if (document.activeElement !== yrsInput) yrsInput.value = sncoState.service.satYears;
                if (document.activeElement !== mosInput) mosInput.value = sncoState.service.satMonths;
            }

            const adminFlags = document.getElementById('admin-flags');
            adminFlags.innerHTML = ['demotion', 'retirement', 'suspended'].map(id => `<div class="flex items-center justify-between"><span class="text-xs font-bold text-slate-700 capitalize">${id.replace('suspended', 'Legal/Hold')}?</span><button onclick="sncoToggleAdminHold('${id}')" class="w-12 h-6 rounded-full relative transition-all ${sncoState.readiness.adminHolds[id] ? 'bg-red-600' : 'bg-slate-300'}"><div class="absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${sncoState.readiness.adminHolds[id] ? 'left-7' : 'left-1'}"></div></button></div>`).join('');

            const auditEl = document.getElementById('audit-results');
            const summaryCard = document.getElementById('audit-summary-card');
            const verdictEl = document.getElementById('audit-summary-verdict');
            const warnings = sncoGetWarnings();
            const isErr = warnings.some(w => w.t === 'error');

            if (warnings.length === 0) {
                auditEl.innerHTML = `<div class="flex-1 flex flex-col items-center justify-center py-10 text-center animate-in fade-in"><div class="w-16 h-16 bg-green-50 rounded-full flex items-center justify-center mb-4 shadow-inner ring-4 ring-green-50/50"><i data-lucide="check-circle-2" class="w-8 h-8 text-green-600"></i></div><p class="text-[11px] font-black text-green-900 uppercase italic tracking-widest">Compliant Record</p></div>`;
                summaryCard.className = "mt-6 p-6 rounded-3xl border-2 bg-green-50 border-green-200 text-green-900";
                verdictEl.innerText = "PASS";
            } else {
                auditEl.innerHTML = warnings.map(w => `<div class="p-4 rounded-2xl border flex gap-3 items-start animate-in zoom-in-95 ${w.t === 'error' ? 'bg-red-50 border-red-100 text-red-700' : 'bg-orange-50 border-orange-100 text-orange-700'}"><i data-lucide="${w.t === 'error' ? 'shield-alert' : 'alert-circle'}" class="w-5 h-5 mt-0.5 shrink-0"></i><div><p class="text-[9px] font-black uppercase opacity-60 tracking-widest leading-none">${w.f}</p><p class="text-[10px] font-bold leading-tight">${w.m}</p></div></div>`).join('');
                summaryCard.className = `mt-6 p-6 rounded-3xl border-2 ${isErr ? 'bg-red-50 border-red-200 text-red-900' : 'bg-orange-50 border-orange-200 text-orange-900'}`;
                verdictEl.innerText = isErr ? "FAIL" : "CAUTION";
            }

            document.getElementById('prev-btn').disabled = sncoState.currentStep === 1;
            const sgtBtn = document.getElementById('first-sgt-btn');
            sgtBtn.innerText = `1st Sgt Mode: ${sncoState.isFirstSgt ? 'ACTIVE' : 'OFF'}`;
            sgtBtn.className = `px-4 py-2 rounded-xl text-[10px] font-black uppercase border-2 transition-all ${sncoState.isFirstSgt ? 'bg-red-600 border-red-600 text-white' : 'bg-white border-slate-200 text-slate-500'}`;
            const nextBtn = document.getElementById('next-btn');
            const statusBadge = document.getElementById('final-status-badge');
            if (sncoState.currentStep < 4) { nextBtn.classList.remove('hidden'); statusBadge.classList.add('hidden'); } 
            else {
                nextBtn.classList.add('hidden'); statusBadge.classList.remove('hidden');
                statusBadge.innerText = isErr ? 'Rejected' : 'Validated for JFHQ';
                statusBadge.className = `px-10 py-3 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg ${isErr ? 'bg-red-600 text-white' : 'bg-green-600 text-white'}`;
            }

            if (sncoState.currentStep === 4) {
                const listEl = document.getElementById('folder-checklist');
                const items = [{id:'ca26',l:'CA ANG Form 26'},{id:'sou',l:'Service SOU (Att 3)'},{id:'memo',l:'Board Letter'},{id:'epb',l:'EPB'},{id:'fit',l:'Fitness Printout'},{id:'sec_clearance',l:'Sec Clearance Memo'},{id:'retrain_sou',l:'Retrain SOU',h:!isRetraining},{id:'first_sgt_sou',l:'1st Sgt SOU',h:!sncoState.isFirstSgt}];
                listEl.innerHTML = items.filter(i=>!i.h).map(i=>`<div onclick="sncoToggleCheck('${i.id}')" class="p-3 rounded-2xl border-2 flex items-center justify-between cursor-pointer transition-all ${sncoState.checklist[i.id]?'bg-blue-600 border-blue-600 text-white':'bg-white border-slate-100'}"><span class="text-[10px] font-black uppercase tracking-tight">${i.l}</span>${sncoState.checklist[i.id]?'<i data-lucide="check-circle-2" class="w-4 h-4 text-white"></i>':'<div class="w-4 h-4 rounded-full border-2 border-slate-200"></div>'}</div>`).join('');
                document.getElementById('board-req-text').innerText = sncoState.profile.packageType.startsWith('STEP') ? s.stepComposition : s.composition;
                document.getElementById('board-comp-checkbox').checked = sncoState.board.compositionMet;
            }
            lucide.createIcons();
        }

        window.onload = function() {
            setupGuidanceSystem();
            sncoRender();
        }
    </script>
</body>
</html>
